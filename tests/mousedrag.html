<!doctype html>
<html>
<head>
    <meta charset='utf-8'>
    <title>g2 - mouse drag</title>
    <style> canvas { border: 1px solid #000; } </style>
</head>

<body>
    <h1>g2 - mouse drag</h1>
    <canvas id="c" width="500", height="300"></canvas>
    <script src='../g2.js'></script>
    <script>
      var ctx = document.getElementById("c").getContext("2d"),
          sqr = {
             x:100,y:80,a:20,hit:false,dirty:true,
             draw: function(g) { 
                if (this.dirty) {
                   g.del().beg().style({ls:this.hit?"green":"orange",fs:"#eee"}).rec(this.x-this.a,this.y-this.a,2*this.a,2*this.a).end();
                   this.dirty = false;
                }
             },
             over: function(p) { var dx=p.x-this.x,dy=p.y-this.y; return dx<this.a && dx>-this.a && dy<this.a && dy>-this.a; },
             drag: function(v) { this.x+=v.x; this.y+=v.y; },
             onmove: function(g,e) {
                var tg = e.target, rec = tg.getBoundingClientRect(),
                    p = g.pntToUsr(e.clientX - Math.floor(rec.left) + tg.scrollLeft,
                                   e.clientY - Math.floor(rec.top)  + tg.scrollTop,
                                   rec.height),
                    over = this.over(p);
                if (this.hit) {
                   if (e.buttons !== undefined ? e.buttons : (e.which || e.button)) { // button pressed ..
                      this.drag(g.vecToUsr(e.movementX || e.mozMovementX || e.webkitMovementX || 0,
                                           e.movementY || e.mozMovementY || e.webkitMovementY || 0));
                      this.dirty = true;
                   }
                   else if (!over)
                      this.dirty = !(this.hit = false);
                }
                else if (over)
                   this.dirty = this.hit = true;

                mouseLoc.del().txt("mouse: ("+p.x+","+p.y+")",10,280);
                e.preventDefault(); 
                return false; 
             },
             onenter: function(e) { 
                ctx.canvas.addEventListener("mousemove", mousemoveHdl, false);
                bg.grid(); 
                return false; 
             },
             onleave: function(e) { 
                ctx.canvas.removeEventListener("mousemove", mousemoveHdl, false);
                bg.del();
                this.dirty = !(this.hit = false); 
                return false; 
             }
          },
          origin = g2().beg().style({lw:2,fs:"snow",ls:"blue"}).p().m(20,0).l(0,0).l(0,20).stroke().cir(0,0,4).end(),
          mouseLoc = g2(),
          bg = g2(),
          geo = g2(),
          g = g2({cartesian:true}).clr().use(bg).pan(10,10).use(origin).use(mouseLoc).use(geo),
          mousemoveHdl = sqr.onmove.bind(sqr,g);

          function render() { sqr.draw(geo); g.exe(ctx); requestAnimationFrame(render); }

          ctx.canvas.addEventListener("mouseenter", sqr.onenter.bind(sqr), false);
          ctx.canvas.addEventListener("mouseleave", sqr.onleave.bind(sqr), false);

          render();
   </script>
</body>
</html>