<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>g2 Tests</title>
    <!-- use bootstrap for styling -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <style>
        canvas,
        img,
        td {
            border-style: solid;
        }

        td,
        th {
            border: 1px solid black;
            white-space: pre;
            font: 11px monospace;
        }
    </style>
</head>

<body>
    <!-- Import g2 -->
    <script src="https://gitcdn.xyz/repo/goessner/g2/master/src/g2.js"></script>
    <!-- Import tests -->
    <script>
        const allTestContainer = [];
        allTestContainer.hrefTemplate = "https://github.com/goessner/g2/blob/master/docs/api/g2.$.md";
        class TestContainer {
            constructor(name, tests) {
                this.name = name;
                this.tests = tests;
                allTestContainer.push(this);
            }
        }

        class Test {
            constructor(name, src) {
                this.name = name;
                this.src = src;
            }
        }

        const pi = Math.PI;
    </script>
    <script src="./index/index.js"></script>
    <script src="./index/index.ext.js"></script>
    <script src="./index/index.mec.js"></script>
    <script src="./index/index.chart.js"></script>
    <div class="container-fluid" id="container">
        <h1>g2 Tests</h1>
        <h6>g2.js, g2.ext.js, g2.mec.js are referenced. canvas and image should look alike.</h6>
        <p id="errind">Error found at: </p>
        <p id="diffind">Differences at: </p>
    </div>
    <script>
        let globalItr = 0;
        let errind = document.getElementById('errind');
        let diffind = document.getElementById('diffind');

        let testingData = [];

        const tests = window.chrome
            ? 'https://raw.githubusercontent.com/goessner/g2/WIP/index-overhaul/docs/index/index.chrome.json'
            : 'https://raw.githubusercontent.com/goessner/g2/WIP/index-overhaul/docs/index/index.firefox.json';

        fetch(tests)
            .then(response => response.json())
            .then((data) => data.forEach(createList));

        function createList({name, tests}) {
            const container = document.querySelector('#container');

            const heading = document.createElement('h3');
            const a = document.createElement('a');
            a.innerHTML = 'g2.' + name;
            a.href = allTestContainer.hrefTemplate.replace('$', name);
            heading.innerHTML = 'Tests for ';
            heading.appendChild(a);

            const table = document.createElement("table");
            table.classList.add("table", "table-hover");

            const thead = document.createElement("thead");
            thead.classList.add("thead-dark");
            const tableRow = document.createElement("tr");

            function addColumn(e) {
                const t = document.createElement("th");
                t.scope = "row";
                t.innerHTML = e;
                return t;
            }
            const th = ["#", "name", "src", "canvas", "image", "error"].map(addColumn);  

            const tbody = document.createElement('tbody');

            container.appendChild(heading);
            container.appendChild(table);
            table.appendChild(thead);
            table.appendChild(tbody);
            thead.appendChild(tableRow);
            th.forEach(a => tableRow.appendChild(a));

            let itr = 0;
            function createListEntry(entry) {
                const tr = document.createElement('tr');
                tr.id = name + 'Test' + itr++;
                
                const number = document.createElement('td');
                number.innerHTML = itr;
                
                const testName = document.createElement('td');
                const testLink = document.createElement('a');
                testLink.innerHTML = entry.name;

                testLink.href = a.href + '#g2+' + (entry.name.match(/-[1-9]+$/) ?
                    entry.name.slice(0,entry.name.lastIndexOf('-')) : entry.name);
                testName.appendChild(testLink);

                const src = document.createElement('td');
                src.innerHTML = entry.src;
                
                const canvas = document.createElement('td');
                const canvasArea = document.createElement('canvas');
                canvasArea.classList.add('testCanvas');
                const ctx = canvasArea.getContext('2d');
                canvas.appendChild(canvasArea);
                
                const image = document.createElement('td');
                const imageArea = document.createElement('canvas');
                const imageCtx = imageArea.getContext('2d');
                g2().img({uri:testingData[globalItr]}).exe(imageCtx);
                image.appendChild(imageArea);
                
                const error = document.createElement('td');
                
                [number, testName, src, canvas, image, error].forEach(e => tr.appendChild(e));
                tbody.appendChild(tr);
                try {
                    g2().del().clr().exe(ctx);
                    eval(entry.src).exe(ctx);
                    if( canvasArea.toDataURL() !== testingData[globalItr] ) {
                        diffind.innerHTML += 'g2.' + name + ': ' + itr + ', ';
                    }
                }
                catch (e) {
                    error.innerHTML = e;
                    tr.classList.add('table-danger');
                    errind.innerHTML += 'g2.' + name + ': ' + itr;
                }
                globalItr++;
            }
            tests.forEach(createListEntry);
        }

        function getTests() {
            const a = document.getElementsByClassName('testCanvas');
            const tests = [];
            for (let itr = 0; itr < a.length; ++itr) {
                tests.push(a[itr].toDataURL());
            }
            const str = JSON.stringify(tests);
            console.log(str);
        }
    </script>
</body>
</html>