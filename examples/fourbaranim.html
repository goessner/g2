<!doctype html>
<html>
<head>
    <meta charset='utf-8'>
    <title>g2 - fourbar animation</title>
    <style> canvas { border: 1px solid #000; } </style>
</head>

<body>
    <h1>g2 - fourbar animation</h1>
    <canvas id="c" width="400", height="300"></canvas><br>
    <script src='../g2.js'></script>
    <script src='../../g2.ex/g2.ex.js'></script>
    <script>
     // oscillating double rocker only
     var fourbar = Class({
        constructor: function(a,b,c,d) {
           this.a = a;
           this.b = b;
           this.c = c;
           this.d = d;
           this.phia = Math.acos(( a*a - (b+c)*(b+c) + d*d)/(2*a*d));
           this.psia = Math.acos((-(a+b)*(a+b) + c*c + d*d)/(2*c*d));
           this.dphia = this.phia - Math.acos(( (a+b)*(a+b) - c*c + d*d)/(2*(a+b)*d));
           this.dpsia = this.psia - Math.acos((-a*a + (b+c)*(b+c) + d*d)/(2*(b+c)*d));
           this.init();
        },
        init: function() {
           this.phi = 0;
           this.psi = 0;
           this.dphi =  0.04;
           this.dpsi = -0.04;
           this.calc = this.calcByPhi;
        },
        step: function() {
           if (this.calc === this.calcByPhi) {  // controlled by phi ...
              if (this.dphi > 0 && this.phi + this.dphia/2 >  this.phia ||
                  this.dphi < 0 && this.phi - this.dphia/2 < -this.phia) { // set drive to psi
                 this.calc = this.calcByPsi;
                 this.dpsi = -this.dpsi;
              }
              else
                 this.phi += this.dphi;
           }
           else if (this.calc === this.calcByPsi) {  // controlled by psi ...
      console.log(this.psi+" += "+this.dpsi);
              if (this.dpsi > 0 && this.psi + this.dpsia/2 >  this.psia ||
                  this.dpsi < 0 && this.psi - this.dpsia/2 < -this.psia) { // set drive to phi
                 this.calc = this.calcByPhi;
                 this.dphi = -this.dphi;
              }
              else
                 this.psi += this.dpsi;
           }
        },
        calcByPhi: function() {
           var ax = this.a*Math.cos(this.phi), ay = this.a*Math.sin(this.phi),
               gx = this.d - ax, gy = -ay, gg = gx*gx + gy*gy,
               bbgg = this.b*this.b/gg,
               kappa = (bbgg - this.c*this.c/gg + 1)/2,
               nu = Math.sign(this.dpsi)*Math.sqrt(bbgg - kappa*kappa);
           this.ra = {x:ax,y:ay};
           this.rb = {x:kappa*gx - nu*gy,y:kappa*gy + nu*gx};
           this.rc = {x:this.d - ax - this.rb.x, y:-ay - this.rb.y};
           this.psi = -Math.atan2(this.rc.y,this.rc.x);
        },
        calcByPsi: function() {
           var cx = -this.c*Math.cos(this.psi), cy = this.c*Math.sin(this.psi),
               gx = this.d + cx, gy = cy, gg = gx*gx + gy*gy,
               aagg = this.a*this.a/gg,
               kappa = (aagg - this.b*this.b/gg + 1)/2,
               nu = Math.sign(this.dphi)*Math.sqrt(aagg - kappa*kappa);
           this.rc = {x:cx,y:cy};
           this.ra = {x:kappa*gx - nu*gy,y:kappa*gy + nu*gx};
           this.rb = {x:gx - this.ra.x, y:gy - this.ra.y};
           this.phi = Math.atan2(this.ra.y,this.ra.x);
        },
        draw: function(g) {
           var rA = this.ra,
               rB = {x:rA.x + this.rb.x, y:rA.y + this.rb.y};
           g.del().p().m(0,0).l(rA.x,rA.y).l(rB.x,rB.y).l(this.d,0).drw()
            .cir(rA.x,rA.y,3).cir(rB.x,rB.y,3).cir(0,0,3).cir(this.d,0,3);
           g.style({ ls:"green" });
           if (this.calc === this.calcByPhi) g.cir(rA.x,rA.y,3);
           else                              g.cir(rB.x,rB.y,3);
//           g.txt("psi="+Math.round(this.psi/Math.PI*180),-10,40);
           return g;
        }
     });
     function over(e) { active = false; }
     function out(e) { active = true; }
     function render() {
//        console.log(".");
        if (active) {
           fb.calc();
           fb.draw(fbg);
           fb.step();
           g.exe(ctx);
        }
        requestAnimationFrame(render); 
     }
	  var fb = fourbar.create(25, 50, 30, 70),
         ctx = document.getElementById("c").getContext("2d"),
         active = true,
         fbg = g2();
         g = g2({cartesian:true})
               .clr()
               .grid()
               .style({ lw:2, ld:[15,4,2,4] })
               .lin(100,150,310,150)
               .style({ ls:"#666", fs:"#fee", lw:2, lj:"round", ld:[] })
               .use(fbg,100,150,0,3);

     ctx.canvas.addEventListener("mouseover",over,false);
     ctx.canvas.addEventListener("mouseout",out,false);
     render();
   </script>
</body>
</html>