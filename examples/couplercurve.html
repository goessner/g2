<!doctype html>
<html>
<head>
    <meta charset='utf-8'>
    <title>g2 - coupler curve</title>
    <style> canvas { border: 1px solid #000; } </style>
</head>

<body>
    <h1>g2 - coupler curve</h1>
    <canvas id="c" width="400", height="300"></canvas><br>
    <input id="slider" type="range" style="min-width:375px;vertical-align:middle;margin:0;padding:0" min="0" max="360" value="0" step="1" />
    <output id="angle" for="slider" style="text-align:right;">0</output>
    <script src='../g2.js'></script>
    <script src='../../g2.ex/g2.ex.js'></script>
    <script>
     function fourbar_phi(a,b,c,d,phi) {
        var cp = Math.cos(phi), sp = Math.sin(phi),
            ax = a*cp, ay = a*sp,
            gx = d - ax, gy = -ay, gg = gx*gx + gy*gy,
            bbgg = b*b/gg,
            kappa = (bbgg - c*c/gg + 1)/2,
            nu = Math.sqrt(bbgg - kappa*kappa);
        return { rA:{x:ax,y:ay}, rB:{x:ax + kappa*gx - nu*gy,y: ay + kappa*gy + nu*gx} };
     }
     function drawFourbar(g,rA,rB,rC,rB0) {
        g.style({ fs:"#eee", ls:"transparent" })
         .ply([rA.x,rA.y,rB.x,rB.y,rC.x,rC.y])
		 .style({ fs:"transparent", ls:"@nodcolor", lw:4 })
         .ply([0,0,rA.x,rA.y,rB.x,rB.y,rB0.x,rB0.y])
         .style({ fs:"@nodfill", lw:1 })
         .cir(rA.x,rA.y,5)
         .cir(rB.x,rB.y,5)
         .cir(rC.x,rC.y,5)
         .use("nodfix",rB0.x,rB0.y)
         .use("nodfix",0,0);
        return g;
     }
     function setAngle(e) {
        if (angle.value !== slider.value) {
           phi = (angle.value = slider.value)/180*Math.PI;
           dirty = true;
        }
        return true;
     }
     function render() {
        if (dirty) {
           var bx, by;
           fbpts = fourbar_phi(a,b,c,d,phi);
           bx = fbpts.rB.x - fbpts.rA.x; by = fbpts.rB.y - fbpts.rA.y;
           fb.del().cpy(drawFourbar(fb,fbpts.rA,fbpts.rB,{x:fbpts.rA.x+lam*bx-mu*by,y:fbpts.rA.y+lam*by+mu*bx},{x:d,y:0}));
           g.exe(ctx); 
           dirty = false;
        }
        requestAnimationFrame(render); 
     }

     var ctx = document.getElementById("c").getContext("2d"),
         slider = document.getElementById("slider"),
         angle = document.getElementById("angle"),
	      a = 50, b = 100, c = 100, d = 120, phi = 0, ra, rb, rc, dirty = true, fbpts,
         lam = 0.5, mu = 0.5,
         fb = g2(),
         g = g2({cartesian:true})
               .clr()
               .grid()
               .style({ ls:"#666", fs:"#fee", lw:2, lj:"round" })
               .use(fb,100,100);

     slider.addEventListener("input",setAngle,false);
     render();
   </script>
</body>
</html>