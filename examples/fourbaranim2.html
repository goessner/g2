<!doctype html>
<html>
<head>
    <meta charset='utf-8'>
    <title>g2 - fourbar animation 02</title>
    <style> canvas { border: 1px solid #000; } </style>
</head>

<body>
    <h1>g2 - fourbar animation 02</h1>
    <canvas id="c" width="400", height="300"></canvas><br>
    <script src='../g2.js'></script>
    <script src='../../g2.ex/g2.ex.js'></script>
    <script>
     // fourbar
     var fourbar = Class({
        constructor: function(a,b,c,d) {
           this.a = a;
           this.b = b;
           this.c = c;
           this.d = d;
           this.dirty = true;
           this.active = true;
           this.hit = false;
           this.init();
        },
        init: function() {
           this.phi = 0;
           this.dphi =  0.04;
           this.calc = this.calcByPhi;
        },
        step: function() {
           this.phi = (this.phi + this.dphi) % (2*Math.PI);
        },
        calcByPhi: function() {
           var ax = this.a*Math.cos(this.phi), ay = this.a*Math.sin(this.phi),
               gx = this.d - ax, gy = -ay, gg = gx*gx + gy*gy,
               bbgg = this.b*this.b/gg,
               kappa = (bbgg - this.c*this.c/gg + 1)/2,
               nu = Math.sqrt(bbgg - kappa*kappa);
//               if (nu < 0.002) nu = -nu; // test
           this.rA  = {x:ax,y:ay};
           this.rB  = {x:ax + kappa*gx - nu*gy,y:ay + kappa*gy + nu*gx};
           this.rB0 = {x:this.d,y:0};
//           this.psi = -Math.atan2(this.rB.y-this.rB0.y,this.rB.x-this.rB0.x);
        },
        node: function(g,x,y,hit) {
           return hit ? g.beg().style({ls:"green",fs:"lightgreen"}).cir(x,y,9).end() : g.cir(x,y,9);
        },
        draw: function(g) {
           var rA = this.rA,
               rB = this.rB;
           g.del().p().m(0,0).l(rA.x,rA.y).l(rB.x,rB.y).l(this.d,0).drw()
            .cir(0,0,9)  // A0
            .cpy(this.node(g,rA.x,rA.y,this.hit==="A"))
            .cpy(this.node(g,rB.x,rB.y,this.hit==="B"))
            .cpy(this.node(g,this.d,0,this.hit==="B0"));
           return g;
        },
        over: function(p) {
           var r = 9;
           if (Math.hypot(this.rA.x-p.x,this.rA.y-p.y) < 9) // hit A ..
              return "A";
           else if (Math.hypot(this.rB.x-p.x,this.rB.y-p.y) < 9) // hit B ..
              return "B";
           else if (Math.hypot(this.rB0.x-p.x,this.rB0.y-p.y) < 9) // hit B0 ..
              return "B0";
        },
        drag: function(v) {
           if (this.hit === "A") {
              this.rA.x += v.x; this.rA.y += v.y;
              this.a = Math.hypot(this.rA.x, this.rA.y);
              this.b = Math.hypot(this.rB.x - this.rA.x, this.rB.y - this.rA.y);
              this.phi = Math.atan2(this.rA.y,this.rA.x) + 2*Math.PI;
           }
           else if (this.hit === "B") {
              this.rB.x += v.x; this.rB.y += v.y;
              this.b = Math.hypot(this.rB.x - this.rA.x, this.rB.y - this.rA.y);
              this.c = Math.hypot(this.rB.x - this.rB0.x, this.rB.y - this.rB0.y);
           }
           else if (this.hit === "B0") {
              this.d = this.rB0.x += v.x;  // drag horizontally only ..
              this.c = Math.hypot(this.rB.x - this.rB0.x, this.rB.y - this.rB0.y);
           }
        }
     });

     function mouseenter(e) {
        this.active = false;  // stop simulation
        bgg.grid();
        this.dirty = true;
        ctx.canvas.addEventListener("mousemove", mousemoveHdl, false);
     }
     function mouseleave(e) { 
        this.active = true;   // run simulation
        bgg.del();
        this.dirty = !(this.hit = false); 
        ctx.canvas.removeEventListener("mousemove", mousemoveHdl, false);
     }
     function mousemove(g,e) {
        var tg = e.target, rec = tg.getBoundingClientRect(),
            p = g.pntToUsr(e.clientX - Math.floor(rec.left) + tg.scrollLeft,
                           e.clientY - Math.floor(rec.top)  + tg.scrollTop,
                           rec.height),
            over = this.over({x:p.x,y:p.y});
        if (this.hit) {
           if (e.buttons !== undefined ? e.buttons : (e.which || e.button)) { // button pressed ..
              this.drag(g.vecToUsr(e.movementX || e.mozMovementX || e.webkitMovementX || 0,
                                   e.movementY || e.mozMovementY || e.webkitMovementY || 0));
              this.dirty = true;
           }
           else if (!over)
              this.dirty = !(this.hit = false);
        }
        else if (over)
           this.dirty = !!(this.hit = over);

        edit.del()
            .style({lw:3,ld:[15,4,2,4]})
            .lin(0,0,fb.d,0)
            .txt("mouse: ("+p.x+","+p.y+")",-80,-90);
        e.preventDefault(); 
        return false; 
     }
     function render() {
//        console.log(".");
        if (fb.active) {
           fb.calc();
           fb.step();
        }
        if (fb.dirty || fb.active) {
           fb.draw(mecg);
           fb.dirty = false;
        }
        g.exe(ctx);
        requestAnimationFrame(render); 
     }
     var fb = fourbar.create(50, 150, 50, 150),
//     var fb = fourbar.create(50, 150, 140, 210),
         ctx = document.getElementById("c").getContext("2d"),
         edit = g2().style({lw:3,ld:[15,4,2,4]}).lin(0,0,fb.d,0),
         bgg = g2(),
         mecg = g2(),
         g = g2({cartesian:true})
               .clr()
               .pan(100,100)
               .use(bgg)
               .use(edit)
               .style({ls:"#666", fs:"#fee", lw:6, lj:"round", ld:[]})
               .use(mecg),
         mousemoveHdl = mousemove.bind(fb,g);

     ctx.canvas.addEventListener("mouseenter", mouseenter.bind(fb), false);
     ctx.canvas.addEventListener("mouseleave", mouseleave.bind(fb), false);

     render();
   </script>
</body>
</html>